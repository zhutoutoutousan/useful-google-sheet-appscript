// ========================================
// ğŸ”§ å·¥å…·å‡½æ•°æ¨¡å—
// ========================================
// æä¾›ç³»ç»Ÿé€šç”¨çš„å·¥å…·å‡½æ•°å’Œè¾…åŠ©æ–¹æ³•

// ========================================
// ğŸ“Š æ•°æ®æŸ¥è¯¢å’Œç»Ÿè®¡å‡½æ•°
// ========================================

/**
 * è·å–å­¦ç”Ÿç§¯åˆ†æ’è¡Œæ¦œ
 */
function è·å–å­¦ç”Ÿç§¯åˆ†æ’è¡Œ() {
  const å­¦ç”ŸSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å­¦ç”Ÿä¿¡æ¯');
  const å¥–åŠ±Sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å¥–åŠ±ç³»ç»Ÿ');
  
  const å­¦ç”Ÿæ•°æ® = å­¦ç”ŸSheet.getDataRange().getValues();
  const å¥–åŠ±æ•°æ® = å¥–åŠ±Sheet.getDataRange().getValues();
  
  const å­¦ç”Ÿç§¯åˆ† = {};
  
  // ç»Ÿè®¡æ¯ä¸ªå­¦ç”Ÿçš„æ€»ç§¯åˆ†
  for (let i = 1; i < å¥–åŠ±æ•°æ®.length; i++) {
    const å­¦ç”ŸID = å¥–åŠ±æ•°æ®[i][1];
    const ç§¯åˆ† = å¥–åŠ±æ•°æ®[i][3] || 0;
    
    if (å­¦ç”Ÿç§¯åˆ†[å­¦ç”ŸID]) {
      å­¦ç”Ÿç§¯åˆ†[å­¦ç”ŸID] += ç§¯åˆ†;
    } else {
      å­¦ç”Ÿç§¯åˆ†[å­¦ç”ŸID] = ç§¯åˆ†;
    }
  }
  
  // æ„å»ºæ’è¡Œæ¦œæ•°æ®
  const æ’è¡Œæ¦œ = [];
  for (let i = 1; i < å­¦ç”Ÿæ•°æ®.length; i++) {
    const å­¦ç”ŸID = å­¦ç”Ÿæ•°æ®[i][0];
    const å§“å = å­¦ç”Ÿæ•°æ®[i][1];
    const ç­‰çº§ = å­¦ç”Ÿæ•°æ®[i][5];
    const å¾½ç«  = å­¦ç”Ÿæ•°æ®[i][15];
    const æ€»ç§¯åˆ† = å­¦ç”Ÿç§¯åˆ†[å­¦ç”ŸID] || 0;
    
    if (å­¦ç”ŸID) {
      æ’è¡Œæ¦œ.push({
        id: å­¦ç”ŸID,
        name: å§“å,
        level: ç­‰çº§,
        totalPoints: æ€»ç§¯åˆ†,
        badge: å¾½ç« 
      });
    }
  }
  
  // æŒ‰ç§¯åˆ†æ’åº
  æ’è¡Œæ¦œ.sort((a, b) => b.totalPoints - a.totalPoints);
  
  return æ’è¡Œæ¦œ;
}

/**
 * è·å–ç§¯åˆ†å†å²è®°å½•
 */
function è·å–ç§¯åˆ†å†å²(ç­›é€‰å­¦ç”ŸID = '', ç­›é€‰ç±»å‹ = '') {
  const å¥–åŠ±Sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å¥–åŠ±ç³»ç»Ÿ');
  const å­¦ç”ŸSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å­¦ç”Ÿä¿¡æ¯');
  
  const å¥–åŠ±æ•°æ® = å¥–åŠ±Sheet.getDataRange().getValues();
  const å­¦ç”Ÿæ•°æ® = å­¦ç”ŸSheet.getDataRange().getValues();
  
  // åˆ›å»ºå­¦ç”ŸIDåˆ°å§“åçš„æ˜ å°„
  const å­¦ç”Ÿå§“åæ˜ å°„ = {};
  for (let i = 1; i < å­¦ç”Ÿæ•°æ®.length; i++) {
    å­¦ç”Ÿå§“åæ˜ å°„[å­¦ç”Ÿæ•°æ®[i][0]] = å­¦ç”Ÿæ•°æ®[i][1];
  }
  
  const å†å²è®°å½• = [];
  
  for (let i = 1; i < å¥–åŠ±æ•°æ®.length; i++) {
    const è®°å½• = å¥–åŠ±æ•°æ®[i];
    const å­¦ç”ŸID = è®°å½•[1];
    const ç§¯åˆ†ç±»å‹ = è®°å½•[2];
    const ç§¯åˆ†æ•°é‡ = è®°å½•[3];
    const åŸå›  = è®°å½•[4];
    const æ—¶é—´ = è®°å½•[8];
    
    // åº”ç”¨ç­›é€‰æ¡ä»¶
    if (ç­›é€‰å­¦ç”ŸID && å­¦ç”ŸID !== ç­›é€‰å­¦ç”ŸID) continue;
    if (ç­›é€‰ç±»å‹ && ç§¯åˆ†ç±»å‹ !== ç­›é€‰ç±»å‹) continue;
    
    å†å²è®°å½•.push({
      studentId: å­¦ç”ŸID,
      studentName: å­¦ç”Ÿå§“åæ˜ å°„[å­¦ç”ŸID] || 'æœªçŸ¥å­¦ç”Ÿ',
      type: ç§¯åˆ†ç±»å‹,
      points: ç§¯åˆ†æ•°é‡,
      reason: åŸå› ,
      time: æ—¶é—´
    });
  }
  
  // æŒ‰æ—¶é—´å€’åºæ’åˆ—
  å†å²è®°å½•.sort((a, b) => new Date(b.time) - new Date(a.time));
  
  return å†å²è®°å½•.slice(0, 50); // è¿”å›æœ€è¿‘50æ¡è®°å½•
}

/**
 * è·å–ä»»åŠ¡ç»Ÿè®¡æ•°æ®
 */
function è·å–ä»»åŠ¡ç»Ÿè®¡() {
  const ä»»åŠ¡Sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ä»»åŠ¡ç®¡ç†');
  const æ•°æ® = ä»»åŠ¡Sheet.getDataRange().getValues();
  
  const ç»Ÿè®¡ = {
    æ€»ä»»åŠ¡æ•°: 0,
    å¾…å¼€å§‹: 0,
    è¿›è¡Œä¸­: 0,
    å¾…å®¡æ ¸: 0,
    å·²å®Œæˆ: 0,
    å·²è¿‡æœŸ: 0,
    å®Œæˆç‡: 0
  };
  
  const ä»Šå¤© = new Date();
  
  for (let i = 1; i < æ•°æ®.length; i++) {
    const çŠ¶æ€ = æ•°æ®[i][8];
    const æˆªæ­¢æ—¥æœŸ = new Date(æ•°æ®[i][7]);
    
    if (æ•°æ®[i][0]) { // å¦‚æœä»»åŠ¡IDä¸ä¸ºç©º
      ç»Ÿè®¡.æ€»ä»»åŠ¡æ•°++;
      
      if (çŠ¶æ€ === 'å·²å®Œæˆ') {
        ç»Ÿè®¡.å·²å®Œæˆ++;
      } else if (æˆªæ­¢æ—¥æœŸ < ä»Šå¤©) {
        ç»Ÿè®¡.å·²è¿‡æœŸ++;
      } else {
        switch (çŠ¶æ€) {
          case 'å¾…å¼€å§‹': ç»Ÿè®¡.å¾…å¼€å§‹++; break;
          case 'è¿›è¡Œä¸­': ç»Ÿè®¡.è¿›è¡Œä¸­++; break;
          case 'å¾…å®¡æ ¸': ç»Ÿè®¡.å¾…å®¡æ ¸++; break;
        }
      }
    }
  }
  
  ç»Ÿè®¡.å®Œæˆç‡ = ç»Ÿè®¡.æ€»ä»»åŠ¡æ•° > 0 ? (ç»Ÿè®¡.å·²å®Œæˆ / ç»Ÿè®¡.æ€»ä»»åŠ¡æ•° * 100).toFixed(1) : 0;
  
  return ç»Ÿè®¡;
}

/**
 * è·å–å­¦ç”Ÿå­¦ä¹ è¿›åº¦ç»Ÿè®¡
 */
function è·å–å­¦ä¹ è¿›åº¦ç»Ÿè®¡(å­¦ç”ŸID) {
  const æŠ€æœ¯Sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('æŠ€æœ¯å­¦ä¹ ');
  const è‹±è¯­Sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('è‹±è¯­å­¦ä¹ ');
  const ä»»åŠ¡Sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ä»»åŠ¡ç®¡ç†');
  
  const æŠ€æœ¯æ•°æ® = æŠ€æœ¯Sheet.getDataRange().getValues();
  const è‹±è¯­æ•°æ® = è‹±è¯­Sheet.getDataRange().getValues();
  const ä»»åŠ¡æ•°æ® = ä»»åŠ¡Sheet.getDataRange().getValues();
  
  const ç»Ÿè®¡ = {
    æŠ€æœ¯å­¦ä¹ : { æ€»æ•°: 0, å·²å®Œæˆ: 0, å®Œæˆç‡: 0 },
    è‹±è¯­å­¦ä¹ : { æ€»æ•°: 0, å·²å®Œæˆ: 0, å®Œæˆç‡: 0 },
    ä»»åŠ¡: { æ€»æ•°: 0, å·²å®Œæˆ: 0, å®Œæˆç‡: 0 },
    æ€»ç§¯åˆ†: 0,
    å½“å‰å¾½ç« : 'ğŸŒ±'
  };
  
  // ç»Ÿè®¡æŠ€æœ¯å­¦ä¹ 
  for (let i = 1; i < æŠ€æœ¯æ•°æ®.length; i++) {
    if (æŠ€æœ¯æ•°æ®[i][1] === å­¦ç”ŸID) {
      ç»Ÿè®¡.æŠ€æœ¯å­¦ä¹ .æ€»æ•°++;
      if (æŠ€æœ¯æ•°æ®[i][4] === 'å·²å®Œæˆ') {
        ç»Ÿè®¡.æŠ€æœ¯å­¦ä¹ .å·²å®Œæˆ++;
      }
    }
  }
  
  // ç»Ÿè®¡è‹±è¯­å­¦ä¹ 
  for (let i = 1; i < è‹±è¯­æ•°æ®.length; i++) {
    if (è‹±è¯­æ•°æ®[i][1] === å­¦ç”ŸID) {
      ç»Ÿè®¡.è‹±è¯­å­¦ä¹ .æ€»æ•°++;
      if (è‹±è¯­æ•°æ®[i][4] === 'å·²å®Œæˆ') {
        ç»Ÿè®¡.è‹±è¯­å­¦ä¹ .å·²å®Œæˆ++;
      }
    }
  }
  
  // ç»Ÿè®¡ä»»åŠ¡
  for (let i = 1; i < ä»»åŠ¡æ•°æ®.length; i++) {
    if (ä»»åŠ¡æ•°æ®[i][2] === å­¦ç”ŸID) {
      ç»Ÿè®¡.ä»»åŠ¡.æ€»æ•°++;
      if (ä»»åŠ¡æ•°æ®[i][8] === 'å·²å®Œæˆ') {
        ç»Ÿè®¡.ä»»åŠ¡.å·²å®Œæˆ++;
      }
    }
  }
  
  // è®¡ç®—å®Œæˆç‡
  ç»Ÿè®¡.æŠ€æœ¯å­¦ä¹ .å®Œæˆç‡ = ç»Ÿè®¡.æŠ€æœ¯å­¦ä¹ .æ€»æ•° > 0 ? (ç»Ÿè®¡.æŠ€æœ¯å­¦ä¹ .å·²å®Œæˆ / ç»Ÿè®¡.æŠ€æœ¯å­¦ä¹ .æ€»æ•° * 100).toFixed(1) : 0;
  ç»Ÿè®¡.è‹±è¯­å­¦ä¹ .å®Œæˆç‡ = ç»Ÿè®¡.è‹±è¯­å­¦ä¹ .æ€»æ•° > 0 ? (ç»Ÿè®¡.è‹±è¯­å­¦ä¹ .å·²å®Œæˆ / ç»Ÿè®¡.è‹±è¯­å­¦ä¹ .æ€»æ•° * 100).toFixed(1) : 0;
  ç»Ÿè®¡.ä»»åŠ¡.å®Œæˆç‡ = ç»Ÿè®¡.ä»»åŠ¡.æ€»æ•° > 0 ? (ç»Ÿè®¡.ä»»åŠ¡.å·²å®Œæˆ / ç»Ÿè®¡.ä»»åŠ¡.æ€»æ•° * 100).toFixed(1) : 0;
  
  // è·å–æ€»ç§¯åˆ†å’Œå¾½ç« 
  ç»Ÿè®¡.æ€»ç§¯åˆ† = è·å–å­¦ç”Ÿæ€»ç§¯åˆ†(å­¦ç”ŸID);
  ç»Ÿè®¡.å½“å‰å¾½ç«  = è®¡ç®—å¾½ç« ç­‰çº§(ç»Ÿè®¡.æ€»ç§¯åˆ†);
  
  return ç»Ÿè®¡;
}

// ========================================
// ğŸ“… æ—¥æœŸå’Œæ—¶é—´å·¥å…·å‡½æ•°
// ========================================

/**
 * æ ¼å¼åŒ–æ—¥æœŸ
 */
function æ ¼å¼åŒ–æ—¥æœŸ(æ—¥æœŸ, æ ¼å¼ = 'yyyy-mm-dd') {
  if (!æ—¥æœŸ) return '';
  
  const date = new Date(æ—¥æœŸ);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  
  switch (æ ¼å¼) {
    case 'yyyy-mm-dd':
      return `${year}-${month}-${day}`;
    case 'yyyy-mm-dd hh:mm':
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    case 'mm/dd/yyyy':
      return `${month}/${day}/${year}`;
    case 'ä¸­æ–‡æ—¥æœŸ':
      return `${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;
    default:
      return date.toLocaleDateString();
  }
}

/**
 * è®¡ç®—æ—¥æœŸå·®
 */
function è®¡ç®—æ—¥æœŸå·®(å¼€å§‹æ—¥æœŸ, ç»“æŸæ—¥æœŸ, å•ä½ = 'days') {
  const start = new Date(å¼€å§‹æ—¥æœŸ);
  const end = new Date(ç»“æŸæ—¥æœŸ);
  const diffTime = Math.abs(end - start);
  
  switch (å•ä½) {
    case 'days':
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    case 'hours':
      return Math.ceil(diffTime / (1000 * 60 * 60));
    case 'minutes':
      return Math.ceil(diffTime / (1000 * 60));
    default:
      return diffTime;
  }
}

/**
 * åˆ¤æ–­æ˜¯å¦è¿‡æœŸ
 */
function æ˜¯å¦è¿‡æœŸ(æˆªæ­¢æ—¥æœŸ) {
  const now = new Date();
  const due = new Date(æˆªæ­¢æ—¥æœŸ);
  return due < now;
}

// ========================================
// ğŸ“§ é€šçŸ¥å’Œæé†’å‡½æ•°
// ========================================

/**
 * å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆéœ€è¦é…ç½®é‚®ä»¶æœåŠ¡ï¼‰
 */
function å‘é€é‚®ä»¶é€šçŸ¥(æ”¶ä»¶äººé‚®ç®±, ä¸»é¢˜, å†…å®¹) {
  try {
    // è¿™é‡Œå¯ä»¥ä½¿ç”¨ GmailApp æˆ–å…¶ä»–é‚®ä»¶æœåŠ¡
    console.log(`ğŸ“§ é‚®ä»¶é€šçŸ¥: ${æ”¶ä»¶äººé‚®ç®±} - ${ä¸»é¢˜}`);
    console.log(`å†…å®¹: ${å†…å®¹}`);
    
    // ç¤ºä¾‹ä»£ç ï¼ˆéœ€è¦å¯ç”¨Gmail APIï¼‰
    // GmailApp.sendEmail(æ”¶ä»¶äººé‚®ç®±, ä¸»é¢˜, å†…å®¹);
    
    return true;
  } catch (error) {
    console.error('é‚®ä»¶å‘é€å¤±è´¥:', error);
    return false;
  }
}

/**
 * æ‰¹é‡å‘é€ä»»åŠ¡æé†’
 */
function æ‰¹é‡å‘é€ä»»åŠ¡æé†’() {
  const ä»»åŠ¡Sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ä»»åŠ¡ç®¡ç†');
  const å­¦ç”ŸSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å­¦ç”Ÿä¿¡æ¯');
  
  const ä»»åŠ¡æ•°æ® = ä»»åŠ¡Sheet.getDataRange().getValues();
  const å­¦ç”Ÿæ•°æ® = å­¦ç”ŸSheet.getDataRange().getValues();
  
  // åˆ›å»ºå­¦ç”ŸIDåˆ°é‚®ç®±çš„æ˜ å°„
  const å­¦ç”Ÿé‚®ç®±æ˜ å°„ = {};
  for (let i = 1; i < å­¦ç”Ÿæ•°æ®.length; i++) {
    å­¦ç”Ÿé‚®ç®±æ˜ å°„[å­¦ç”Ÿæ•°æ®[i][0]] = å­¦ç”Ÿæ•°æ®[i][2];
  }
  
  const ä»Šå¤© = new Date();
  const æ˜å¤© = new Date(ä»Šå¤©.getTime() + 24 * 60 * 60 * 1000);
  
  let å‘é€è®¡æ•° = 0;
  
  for (let i = 1; i < ä»»åŠ¡æ•°æ®.length; i++) {
    const ä»»åŠ¡ = ä»»åŠ¡æ•°æ®[i];
    const å­¦ç”ŸID = ä»»åŠ¡[2];
    const ä»»åŠ¡æ ‡é¢˜ = ä»»åŠ¡[4];
    const æˆªæ­¢æ—¥æœŸ = new Date(ä»»åŠ¡[7]);
    const çŠ¶æ€ = ä»»åŠ¡[8];
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æé†’ï¼ˆæˆªæ­¢æ—¥æœŸåœ¨æ˜å¤©ä¸”ä»»åŠ¡æœªå®Œæˆï¼‰
    if (çŠ¶æ€ !== 'å·²å®Œæˆ' && æˆªæ­¢æ—¥æœŸ.toDateString() === æ˜å¤©.toDateString()) {
      const å­¦ç”Ÿé‚®ç®± = å­¦ç”Ÿé‚®ç®±æ˜ å°„[å­¦ç”ŸID];
      if (å­¦ç”Ÿé‚®ç®±) {
        const ä¸»é¢˜ = `â° ä»»åŠ¡æé†’ï¼š${ä»»åŠ¡æ ‡é¢˜}`;
        const å†…å®¹ = `
          äº²çˆ±çš„åŒå­¦ï¼Œ
          
          æ‚¨æœ‰ä¸€ä¸ªä»»åŠ¡å³å°†åˆ°æœŸï¼š
          
          ä»»åŠ¡æ ‡é¢˜ï¼š${ä»»åŠ¡æ ‡é¢˜}
          æˆªæ­¢æ—¶é—´ï¼š${æ ¼å¼åŒ–æ—¥æœŸ(æˆªæ­¢æ—¥æœŸ, 'yyyy-mm-dd hh:mm')}
          
          è¯·åŠæ—¶å®Œæˆå¹¶æäº¤ã€‚
          
          ç¥å­¦ä¹ æ„‰å¿«ï¼
          è®­ç»ƒè¥ç®¡ç†å›¢é˜Ÿ
        `;
        
        if (å‘é€é‚®ä»¶é€šçŸ¥(å­¦ç”Ÿé‚®ç®±, ä¸»é¢˜, å†…å®¹)) {
          å‘é€è®¡æ•°++;
        }
      }
    }
  }
  
  console.log(`ğŸ“§ å·²å‘é€ ${å‘é€è®¡æ•°} æ¡ä»»åŠ¡æé†’`);
  return å‘é€è®¡æ•°;
}

// ========================================
// ğŸ“Š æ•°æ®éªŒè¯å’Œæ¸…ç†å‡½æ•°
// ========================================

/**
 * éªŒè¯é‚®ç®±æ ¼å¼
 */
function éªŒè¯é‚®ç®±(é‚®ç®±) {
  const é‚®ç®±æ­£åˆ™ = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return é‚®ç®±æ­£åˆ™.test(é‚®ç®±);
}

/**
 * éªŒè¯ç”µè¯å·ç æ ¼å¼
 */
function éªŒè¯ç”µè¯(ç”µè¯) {
  const ç”µè¯æ­£åˆ™ = /^[\d\s\-\+\(\)]{10,}$/;
  return ç”µè¯æ­£åˆ™.test(ç”µè¯);
}

/**
 * æ¸…ç†å’Œæ ‡å‡†åŒ–æ•°æ®
 */
function æ¸…ç†æ•°æ®(æ•°æ®) {
  if (typeof æ•°æ® === 'string') {
    return æ•°æ®.trim(); // å»é™¤é¦–å°¾ç©ºæ ¼
  }
  return æ•°æ®;
}

/**
 * æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
 */
function æ£€æŸ¥æ•°æ®å®Œæ•´æ€§() {
  const å·¥ä½œè¡¨åˆ—è¡¨ = [
    'å­¦ç”Ÿä¿¡æ¯', 'æ•™å¸ˆä¿¡æ¯', 'æŠ€æœ¯å­¦ä¹ ', 'è‹±è¯­å­¦ä¹ ', 
    'ä»»åŠ¡ç®¡ç†', 'å¥–åŠ±ç³»ç»Ÿ', 'æ±‚èŒç®¡ç†', 'é¡¹ç›®ä½œå“'
  ];
  
  const æ£€æŸ¥ç»“æœ = {
    æ€»å·¥ä½œè¡¨æ•°: å·¥ä½œè¡¨åˆ—è¡¨.length,
    ç¼ºå¤±å·¥ä½œè¡¨: [],
    æ•°æ®ç»Ÿè®¡: {}
  };
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  å·¥ä½œè¡¨åˆ—è¡¨.forEach(å·¥ä½œè¡¨å => {
    const sheet = ss.getSheetByName(å·¥ä½œè¡¨å);
    if (!sheet) {
      æ£€æŸ¥ç»“æœ.ç¼ºå¤±å·¥ä½œè¡¨.push(å·¥ä½œè¡¨å);
    } else {
      const è¡Œæ•° = sheet.getLastRow();
      æ£€æŸ¥ç»“æœ.æ•°æ®ç»Ÿè®¡[å·¥ä½œè¡¨å] = {
        æ€»è¡Œæ•°: è¡Œæ•°,
        æ•°æ®è¡Œæ•°: Math.max(0, è¡Œæ•° - 1) // å‡å»è¡¨å¤´
      };
    }
  });
  
  return æ£€æŸ¥ç»“æœ;
}

// ========================================
// ğŸ¨ ç•Œé¢æ˜¾ç¤ºå‡½æ•°
// ========================================

/**
 * æ˜¾ç¤ºå­¦ç”Ÿç»Ÿè®¡å¯¹è¯æ¡†
 */
function æ˜¾ç¤ºå­¦ç”Ÿç»Ÿè®¡() {
  const å­¦ç”ŸSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å­¦ç”Ÿä¿¡æ¯');
  const æ•°æ® = å­¦ç”ŸSheet.getDataRange().getValues();
  
  let æ€»å­¦ç”Ÿæ•° = 0;
  let åœ¨è¯»å­¦ç”Ÿ = 0;
  let å·²æ¯•ä¸š = 0;
  const ç­‰çº§ç»Ÿè®¡ = {};
  
  for (let i = 1; i < æ•°æ®.length; i++) {
    if (æ•°æ®[i][0]) { // å¦‚æœå­¦ç”ŸIDä¸ä¸ºç©º
      æ€»å­¦ç”Ÿæ•°++;
      const çŠ¶æ€ = æ•°æ®[i][9];
      const ç­‰çº§ = æ•°æ®[i][5];
      
      if (çŠ¶æ€ === 'åœ¨è¯»') åœ¨è¯»å­¦ç”Ÿ++;
      if (çŠ¶æ€ === 'å·²æ¯•ä¸š') å·²æ¯•ä¸š++;
      
      ç­‰çº§ç»Ÿè®¡[ç­‰çº§] = (ç­‰çº§ç»Ÿè®¡[ç­‰çº§] || 0) + 1;
    }
  }
  
  let ç»Ÿè®¡ä¿¡æ¯ = `ğŸ“Š å­¦ç”Ÿç»Ÿè®¡ä¿¡æ¯\n\n`;
  ç»Ÿè®¡ä¿¡æ¯ += `ğŸ‘¥ æ€»å­¦ç”Ÿæ•°: ${æ€»å­¦ç”Ÿæ•°}\n`;
  ç»Ÿè®¡ä¿¡æ¯ += `âœ… åœ¨è¯»å­¦ç”Ÿ: ${åœ¨è¯»å­¦ç”Ÿ}\n`;
  ç»Ÿè®¡ä¿¡æ¯ += `ğŸ“ å·²æ¯•ä¸š: ${å·²æ¯•ä¸š}\n\n`;
  ç»Ÿè®¡ä¿¡æ¯ += `ğŸ“ˆ ç­‰çº§åˆ†å¸ƒ:\n`;
  
  Object.entries(ç­‰çº§ç»Ÿè®¡).forEach(([ç­‰çº§, äººæ•°]) => {
    ç»Ÿè®¡ä¿¡æ¯ += `â€¢ ${ç­‰çº§}: ${äººæ•°}äºº\n`;
  });
  
  SpreadsheetApp.getUi().alert('å­¦ç”Ÿç»Ÿè®¡', ç»Ÿè®¡ä¿¡æ¯, SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * æ˜¾ç¤ºæ•™å¸ˆå·¥ä½œé‡ç»Ÿè®¡
 */
function æ˜¾ç¤ºæ•™å¸ˆå·¥ä½œé‡ç»Ÿè®¡() {
  const æ•™å¸ˆSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('æ•™å¸ˆä¿¡æ¯');
  const ä»»åŠ¡Sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ä»»åŠ¡ç®¡ç†');
  
  const æ•™å¸ˆæ•°æ® = æ•™å¸ˆSheet.getDataRange().getValues();
  const ä»»åŠ¡æ•°æ® = ä»»åŠ¡Sheet.getDataRange().getValues();
  
  // ç»Ÿè®¡æ¯ä¸ªæ•™å¸ˆçš„ä»»åŠ¡æ•°é‡
  const æ•™å¸ˆä»»åŠ¡ç»Ÿè®¡ = {};
  
  for (let i = 1; i < ä»»åŠ¡æ•°æ®.length; i++) {
    const æ•™å¸ˆID = ä»»åŠ¡æ•°æ®[i][3];
    if (æ•™å¸ˆID) {
      æ•™å¸ˆä»»åŠ¡ç»Ÿè®¡[æ•™å¸ˆID] = (æ•™å¸ˆä»»åŠ¡ç»Ÿè®¡[æ•™å¸ˆID] || 0) + 1;
    }
  }
  
  let ç»Ÿè®¡ä¿¡æ¯ = `ğŸ‘¨â€ğŸ« æ•™å¸ˆå·¥ä½œé‡ç»Ÿè®¡\n\n`;
  
  for (let i = 1; i < æ•™å¸ˆæ•°æ®.length; i++) {
    const æ•™å¸ˆID = æ•™å¸ˆæ•°æ®[i][0];
    const æ•™å¸ˆå§“å = æ•™å¸ˆæ•°æ®[i][1];
    const ä¸“ä¸šé¢†åŸŸ = æ•™å¸ˆæ•°æ®[i][4];
    const ä»»åŠ¡æ•°é‡ = æ•™å¸ˆä»»åŠ¡ç»Ÿè®¡[æ•™å¸ˆID] || 0;
    
    if (æ•™å¸ˆID) {
      ç»Ÿè®¡ä¿¡æ¯ += `â€¢ ${æ•™å¸ˆå§“å} (${ä¸“ä¸šé¢†åŸŸ}): ${ä»»åŠ¡æ•°é‡}ä¸ªä»»åŠ¡\n`;
    }
  }
  
  SpreadsheetApp.getUi().alert('æ•™å¸ˆå·¥ä½œé‡', ç»Ÿè®¡ä¿¡æ¯, SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * æ˜¾ç¤ºç§¯åˆ†æ’è¡Œæ¦œå¯¹è¯æ¡†
 */
function æ˜¾ç¤ºç§¯åˆ†æ’è¡Œæ¦œ() {
  const æ’è¡Œæ¦œ = è·å–å­¦ç”Ÿç§¯åˆ†æ’è¡Œ();
  
  let æ’è¡Œä¿¡æ¯ = `ğŸ† ç§¯åˆ†æ’è¡Œæ¦œ (å‰10å)\n\n`;
  
  for (let i = 0; i < Math.min(10, æ’è¡Œæ¦œ.length); i++) {
    const å­¦ç”Ÿ = æ’è¡Œæ¦œ[i];
    const æ’å = i + 1;
    let æ’åå›¾æ ‡ = `${æ’å}.`;
    
    if (æ’å === 1) æ’åå›¾æ ‡ = 'ğŸ¥‡';
    else if (æ’å === 2) æ’åå›¾æ ‡ = 'ğŸ¥ˆ';
    else if (æ’å === 3) æ’åå›¾æ ‡ = 'ğŸ¥‰';
    
    æ’è¡Œä¿¡æ¯ += `${æ’åå›¾æ ‡} ${å­¦ç”Ÿ.name} - ${å­¦ç”Ÿ.totalPoints}åˆ† ${å­¦ç”Ÿ.badge}\n`;
  }
  
  SpreadsheetApp.getUi().alert('ç§¯åˆ†æ’è¡Œæ¦œ', æ’è¡Œä¿¡æ¯, SpreadsheetApp.getUi().ButtonSet.OK);
}

// ========================================
// ğŸ’¾ æ•°æ®å¯¼å‡ºå‡½æ•°
// ========================================

/**
 * å¯¼å‡ºç³»ç»Ÿæ•°æ®
 */
function å¯¼å‡ºç³»ç»Ÿæ•°æ®() {
  const ui = SpreadsheetApp.getUi();
  
  const result = ui.alert(
    'å¯¼å‡ºæ•°æ®',
    'é€‰æ‹©å¯¼å‡ºæ ¼å¼:\n\nç¡®å®š - Excelæ ¼å¼\nå–æ¶ˆ - CSVæ ¼å¼',
    ui.ButtonSet.OK_CANCEL
  );
  
  const æ ¼å¼ = result === ui.Button.OK ? 'excel' : 'csv';
  
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const æ–‡ä»¶å = `è®­ç»ƒè¥æ•°æ®_${æ ¼å¼åŒ–æ—¥æœŸ(new Date(), 'yyyy-mm-dd')}`;
    
    // è¿™é‡Œå¯ä»¥å®ç°å…·ä½“çš„å¯¼å‡ºé€»è¾‘
    console.log(`å¯¼å‡ºæ•°æ®: ${æ–‡ä»¶å}.${æ ¼å¼}`);
    
    ui.alert('å¯¼å‡ºæˆåŠŸ', `æ•°æ®å·²å¯¼å‡ºä¸º ${æ–‡ä»¶å}.${æ ¼å¼}`, ui.ButtonSet.OK);
  } catch (error) {
    console.error('å¯¼å‡ºå¤±è´¥:', error);
    ui.alert('å¯¼å‡ºå¤±è´¥', error.toString(), ui.ButtonSet.OK);
  }
}

// ========================================
// âš™ï¸ ç³»ç»Ÿè®¾ç½®å‡½æ•°
// ========================================

/**
 * æ˜¾ç¤ºç³»ç»Ÿè®¾ç½®
 */
function æ˜¾ç¤ºç³»ç»Ÿè®¾ç½®() {
  const htmlOutput = HtmlService.createHtmlOutputFromFile('ç³»ç»Ÿè®¾ç½®ç•Œé¢')
    .setWidth(600)
    .setHeight(500);
  
  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'âš™ï¸ ç³»ç»Ÿè®¾ç½®');
}

/**
 * æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
 */
function æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯() {
  const å¸®åŠ©å†…å®¹ = `
ğŸ†˜ è®­ç»ƒè¥ç®¡ç†ç³»ç»ŸV2 å¸®åŠ©æ–‡æ¡£

ğŸ“š ä¸»è¦åŠŸèƒ½:
â€¢ å­¦ç”Ÿç®¡ç† - æ·»åŠ ã€ç¼–è¾‘å­¦ç”Ÿä¿¡æ¯
â€¢ æ•™å¸ˆç®¡ç† - ç®¡ç†æ•™å¸ˆèµ„æº
â€¢ ä»»åŠ¡ç³»ç»Ÿ - å¸ƒç½®å’Œç®¡ç†å­¦ä¹ ä»»åŠ¡
â€¢ å¥–åŠ±ç³»ç»Ÿ - ç§¯åˆ†å’Œå¾½ç« ç®¡ç†
â€¢ æ•°æ®åˆ†æ - å­¦ä¹ è¿›åº¦å’Œç»Ÿè®¡æŠ¥å‘Š

ğŸ¯ å¿«é€Ÿæ“ä½œ:
1. æ·»åŠ å­¦ç”Ÿ: å­¦ç”Ÿç®¡ç† > æ·»åŠ æ–°å­¦ç”Ÿ
2. å¸ƒç½®ä»»åŠ¡: ä»»åŠ¡ç®¡ç† > å¸ƒç½®æ–°ä»»åŠ¡
3. å‘æ”¾ç§¯åˆ†: å¥–åŠ±ç³»ç»Ÿ > å‘æ”¾ç§¯åˆ†
4. æŸ¥çœ‹æŠ¥å‘Š: æŠ¥å‘Šåˆ†æ > ç”ŸæˆæŠ¥å‘Š

ğŸ’¡ ä½¿ç”¨æŠ€å·§:
â€¢ ä½¿ç”¨åŠ¨æ€ä¸‹æ‹‰èœå•å¿«é€Ÿé€‰æ‹©
â€¢ å®šæœŸæ£€æŸ¥ä»»åŠ¡å®Œæˆæƒ…å†µ
â€¢ å…³æ³¨å­¦ç”Ÿç§¯åˆ†æ’è¡Œæ¦œ
â€¢ åˆ©ç”¨æ•°æ®å¯¼å‡ºåŠŸèƒ½å¤‡ä»½

ğŸ“ æŠ€æœ¯æ”¯æŒ:
å¦‚æœ‰é—®é¢˜è¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜
  `;
  
  SpreadsheetApp.getUi().alert('å¸®åŠ©æ–‡æ¡£', å¸®åŠ©å†…å®¹, SpreadsheetApp.getUi().ButtonSet.OK);
}

// ========================================
// ğŸ” ä»»åŠ¡æŸ¥è¯¢å‡½æ•°
// ========================================

/**
 * æŒ‰å­¦ç”ŸæŸ¥è¯¢ä»»åŠ¡
 */
function æŒ‰å­¦ç”ŸæŸ¥è¯¢ä»»åŠ¡() {
  const ui = SpreadsheetApp.getUi();
  
  const result = ui.prompt(
    'æŒ‰å­¦ç”ŸæŸ¥è¯¢',
    'è¯·è¾“å…¥å­¦ç”Ÿå§“åï¼ˆéƒ¨åˆ†åŒ¹é…ï¼‰:',
    ui.ButtonSet.OK_CANCEL
  );
  
  if (result.getSelectedButton() !== ui.Button.OK) return '';
  
  const å­¦ç”Ÿå§“å = result.getResponseText();
  const ä»»åŠ¡Sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ä»»åŠ¡ç®¡ç†');
  const å­¦ç”ŸSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å­¦ç”Ÿä¿¡æ¯');
  
  const ä»»åŠ¡æ•°æ® = ä»»åŠ¡Sheet.getDataRange().getValues();
  const å­¦ç”Ÿæ•°æ® = å­¦ç”ŸSheet.getDataRange().getValues();
  
  // åˆ›å»ºå­¦ç”ŸIDåˆ°å§“åçš„æ˜ å°„
  const å­¦ç”Ÿæ˜ å°„ = {};
  for (let i = 1; i < å­¦ç”Ÿæ•°æ®.length; i++) {
    å­¦ç”Ÿæ˜ å°„[å­¦ç”Ÿæ•°æ®[i][0]] = å­¦ç”Ÿæ•°æ®[i][1];
  }
  
  let æŸ¥è¯¢ç»“æœ = `ğŸ” å­¦ç”Ÿ"${å­¦ç”Ÿå§“å}"çš„ä»»åŠ¡åˆ—è¡¨:\n\n`;
  let æ‰¾åˆ°æ•°é‡ = 0;
  
  for (let i = 1; i < ä»»åŠ¡æ•°æ®.length; i++) {
    const å­¦ç”ŸID = ä»»åŠ¡æ•°æ®[i][2];
    const å­¦ç”Ÿå = å­¦ç”Ÿæ˜ å°„[å­¦ç”ŸID];
    
    if (å­¦ç”Ÿå && å­¦ç”Ÿå.includes(å­¦ç”Ÿå§“å)) {
      const ä»»åŠ¡æ ‡é¢˜ = ä»»åŠ¡æ•°æ®[i][4];
      const çŠ¶æ€ = ä»»åŠ¡æ•°æ®[i][8];
      const æˆªæ­¢æ—¥æœŸ = æ ¼å¼åŒ–æ—¥æœŸ(ä»»åŠ¡æ•°æ®[i][7]);
      
      æŸ¥è¯¢ç»“æœ += `â€¢ ${ä»»åŠ¡æ ‡é¢˜} - ${çŠ¶æ€} (æˆªæ­¢: ${æˆªæ­¢æ—¥æœŸ})\n`;
      æ‰¾åˆ°æ•°é‡++;
    }
  }
  
  if (æ‰¾åˆ°æ•°é‡ === 0) {
    æŸ¥è¯¢ç»“æœ += 'æœªæ‰¾åˆ°ç›¸å…³ä»»åŠ¡';
  } else {
    æŸ¥è¯¢ç»“æœ += `\nå…±æ‰¾åˆ° ${æ‰¾åˆ°æ•°é‡} ä¸ªä»»åŠ¡`;
  }
  
  return æŸ¥è¯¢ç»“æœ;
}

/**
 * æŒ‰çŠ¶æ€æŸ¥è¯¢ä»»åŠ¡
 */
function æŒ‰çŠ¶æ€æŸ¥è¯¢ä»»åŠ¡() {
  const ui = SpreadsheetApp.getUi();
  
  const result = ui.prompt(
    'æŒ‰çŠ¶æ€æŸ¥è¯¢',
    'è¯·é€‰æ‹©çŠ¶æ€:\n1-å¾…å¼€å§‹ 2-è¿›è¡Œä¸­ 3-å¾…å®¡æ ¸ 4-å·²å®Œæˆ 5-å·²è¿‡æœŸ',
    ui.ButtonSet.OK_CANCEL
  );
  
  if (result.getSelectedButton() !== ui.Button.OK) return '';
  
  const çŠ¶æ€æ˜ å°„ = {
    '1': 'å¾…å¼€å§‹',
    '2': 'è¿›è¡Œä¸­', 
    '3': 'å¾…å®¡æ ¸',
    '4': 'å·²å®Œæˆ',
    '5': 'å·²è¿‡æœŸ'
  };
  
  const é€‰æ‹©çŠ¶æ€ = çŠ¶æ€æ˜ å°„[result.getResponseText()];
  if (!é€‰æ‹©çŠ¶æ€) return 'âŒ æ— æ•ˆçš„çŠ¶æ€é€‰æ‹©';
  
  const ä»»åŠ¡Sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ä»»åŠ¡ç®¡ç†');
  const å­¦ç”ŸSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å­¦ç”Ÿä¿¡æ¯');
  
  const ä»»åŠ¡æ•°æ® = ä»»åŠ¡Sheet.getDataRange().getValues();
  const å­¦ç”Ÿæ•°æ® = å­¦ç”ŸSheet.getDataRange().getValues();
  
  // åˆ›å»ºå­¦ç”ŸIDåˆ°å§“åçš„æ˜ å°„
  const å­¦ç”Ÿæ˜ å°„ = {};
  for (let i = 1; i < å­¦ç”Ÿæ•°æ®.length; i++) {
    å­¦ç”Ÿæ˜ å°„[å­¦ç”Ÿæ•°æ®[i][0]] = å­¦ç”Ÿæ•°æ®[i][1];
  }
  
  let æŸ¥è¯¢ç»“æœ = `ğŸ” çŠ¶æ€ä¸º"${é€‰æ‹©çŠ¶æ€}"çš„ä»»åŠ¡:\n\n`;
  let æ‰¾åˆ°æ•°é‡ = 0;
  
  for (let i = 1; i < ä»»åŠ¡æ•°æ®.length; i++) {
    const çŠ¶æ€ = ä»»åŠ¡æ•°æ®[i][8];
    
    if (çŠ¶æ€ === é€‰æ‹©çŠ¶æ€) {
      const å­¦ç”ŸID = ä»»åŠ¡æ•°æ®[i][2];
      const å­¦ç”Ÿå = å­¦ç”Ÿæ˜ å°„[å­¦ç”ŸID] || 'æœªçŸ¥å­¦ç”Ÿ';
      const ä»»åŠ¡æ ‡é¢˜ = ä»»åŠ¡æ•°æ®[i][4];
      const æˆªæ­¢æ—¥æœŸ = æ ¼å¼åŒ–æ—¥æœŸ(ä»»åŠ¡æ•°æ®[i][7]);
      
      æŸ¥è¯¢ç»“æœ += `â€¢ ${å­¦ç”Ÿå}: ${ä»»åŠ¡æ ‡é¢˜} (æˆªæ­¢: ${æˆªæ­¢æ—¥æœŸ})\n`;
      æ‰¾åˆ°æ•°é‡++;
    }
  }
  
  if (æ‰¾åˆ°æ•°é‡ === 0) {
    æŸ¥è¯¢ç»“æœ += 'æœªæ‰¾åˆ°ç›¸å…³ä»»åŠ¡';
  } else {
    æŸ¥è¯¢ç»“æœ += `\nå…±æ‰¾åˆ° ${æ‰¾åˆ°æ•°é‡} ä¸ªä»»åŠ¡`;
  }
  
  return æŸ¥è¯¢ç»“æœ;
}

/**
 * æŒ‰æ—¥æœŸæŸ¥è¯¢ä»»åŠ¡
 */
function æŒ‰æ—¥æœŸæŸ¥è¯¢ä»»åŠ¡() {
  const ui = SpreadsheetApp.getUi();
  
  const result = ui.prompt(
    'æŒ‰æˆªæ­¢æ—¥æœŸæŸ¥è¯¢',
    'è¯·é€‰æ‹©æŸ¥è¯¢èŒƒå›´:\n1-ä»Šå¤©åˆ°æœŸ 2-æ˜å¤©åˆ°æœŸ 3-æœ¬å‘¨åˆ°æœŸ 4-å·²è¿‡æœŸ',
    ui.ButtonSet.OK_CANCEL
  );
  
  if (result.getSelectedButton() !== ui.Button.OK) return '';
  
  const ä»Šå¤© = new Date();
  const æ˜å¤© = new Date(ä»Šå¤©.getTime() + 24 * 60 * 60 * 1000);
  const æœ¬å‘¨æœ« = new Date(ä»Šå¤©.getTime() + 7 * 24 * 60 * 60 * 1000);
  
  let å¼€å§‹æ—¥æœŸ, ç»“æŸæ—¥æœŸ, æŸ¥è¯¢æè¿°;
  
  switch (result.getResponseText()) {
    case '1':
      å¼€å§‹æ—¥æœŸ = ä»Šå¤©;
      ç»“æŸæ—¥æœŸ = æ˜å¤©;
      æŸ¥è¯¢æè¿° = 'ä»Šå¤©åˆ°æœŸ';
      break;
    case '2':
      å¼€å§‹æ—¥æœŸ = æ˜å¤©;
      ç»“æŸæ—¥æœŸ = new Date(æ˜å¤©.getTime() + 24 * 60 * 60 * 1000);
      æŸ¥è¯¢æè¿° = 'æ˜å¤©åˆ°æœŸ';
      break;
    case '3':
      å¼€å§‹æ—¥æœŸ = ä»Šå¤©;
      ç»“æŸæ—¥æœŸ = æœ¬å‘¨æœ«;
      æŸ¥è¯¢æè¿° = 'æœ¬å‘¨åˆ°æœŸ';
      break;
    case '4':
      å¼€å§‹æ—¥æœŸ = new Date('2020-01-01');
      ç»“æŸæ—¥æœŸ = ä»Šå¤©;
      æŸ¥è¯¢æè¿° = 'å·²è¿‡æœŸ';
      break;
    default:
      return 'âŒ æ— æ•ˆçš„æ—¥æœŸé€‰æ‹©';
  }
  
  const ä»»åŠ¡Sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ä»»åŠ¡ç®¡ç†');
  const å­¦ç”ŸSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å­¦ç”Ÿä¿¡æ¯');
  
  const ä»»åŠ¡æ•°æ® = ä»»åŠ¡Sheet.getDataRange().getValues();
  const å­¦ç”Ÿæ•°æ® = å­¦ç”ŸSheet.getDataRange().getValues();
  
  // åˆ›å»ºå­¦ç”ŸIDåˆ°å§“åçš„æ˜ å°„
  const å­¦ç”Ÿæ˜ å°„ = {};
  for (let i = 1; i < å­¦ç”Ÿæ•°æ®.length; i++) {
    å­¦ç”Ÿæ˜ å°„[å­¦ç”Ÿæ•°æ®[i][0]] = å­¦ç”Ÿæ•°æ®[i][1];
  }
  
  let æŸ¥è¯¢ç»“æœ = `ğŸ” ${æŸ¥è¯¢æè¿°}çš„ä»»åŠ¡:\n\n`;
  let æ‰¾åˆ°æ•°é‡ = 0;
  
  for (let i = 1; i < ä»»åŠ¡æ•°æ®.length; i++) {
    const æˆªæ­¢æ—¥æœŸ = new Date(ä»»åŠ¡æ•°æ®[i][7]);
    
    if (æˆªæ­¢æ—¥æœŸ >= å¼€å§‹æ—¥æœŸ && æˆªæ­¢æ—¥æœŸ < ç»“æŸæ—¥æœŸ) {
      const å­¦ç”ŸID = ä»»åŠ¡æ•°æ®[i][2];
      const å­¦ç”Ÿå = å­¦ç”Ÿæ˜ å°„[å­¦ç”ŸID] || 'æœªçŸ¥å­¦ç”Ÿ';
      const ä»»åŠ¡æ ‡é¢˜ = ä»»åŠ¡æ•°æ®[i][4];
      const çŠ¶æ€ = ä»»åŠ¡æ•°æ®[i][8];
      
      æŸ¥è¯¢ç»“æœ += `â€¢ ${å­¦ç”Ÿå}: ${ä»»åŠ¡æ ‡é¢˜} - ${çŠ¶æ€}\n`;
      æ‰¾åˆ°æ•°é‡++;
    }
  }
  
  if (æ‰¾åˆ°æ•°é‡ === 0) {
    æŸ¥è¯¢ç»“æœ += 'æœªæ‰¾åˆ°ç›¸å…³ä»»åŠ¡';
  } else {
    æŸ¥è¯¢ç»“æœ += `\nå…±æ‰¾åˆ° ${æ‰¾åˆ°æ•°é‡} ä¸ªä»»åŠ¡`;
  }
  
  return æŸ¥è¯¢ç»“æœ;
}

/**
 * è·å–å¾½ç« ç»Ÿè®¡
 */
function è·å–å¾½ç« ç»Ÿè®¡() {
  const å­¦ç”ŸSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å­¦ç”Ÿä¿¡æ¯');
  const æ•°æ® = å­¦ç”ŸSheet.getDataRange().getValues();
  
  const å¾½ç« ç»Ÿè®¡ = {};
  
  for (let i = 1; i < æ•°æ®.length; i++) {
    if (æ•°æ®[i][0]) { // å¦‚æœå­¦ç”ŸIDä¸ä¸ºç©º
      const å¾½ç«  = æ•°æ®[i][15] || 'æ–°äºº ğŸŒ±';
      å¾½ç« ç»Ÿè®¡[å¾½ç« ] = (å¾½ç« ç»Ÿè®¡[å¾½ç« ] || 0) + 1;
    }
  }
  
  return å¾½ç« ç»Ÿè®¡;
}
